<!DOCTYPE html><html lang="de">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Willkommen im Mousecity Store</title>  
    <style>  
        body{font-family:Arial,sans-serif;margin:0;padding:0;background-color:#f3f3f3}
        header{display:flex;justify-content:space-between;align-items:center;background-color:#232f3e;color:white;padding:10px 20px}
        header h1{margin:0;font-size:1.2em}
        #my-purchases-button{background-color:#4a5d73;border:none;color:white;padding:10px 20px;font-size:1em;cursor:pointer;border-radius:5px}
        #category-buttons{display:flex;justify-content:flex-start;flex-wrap:wrap;background-color:#f3f3f3;padding:10px 20px;border-bottom:1px solid #ddd;gap:10px}
        #category-buttons button{background-color:#e0e0e0;border:1px solid #ccc;padding:8px 12px;border-radius:5px;cursor:pointer;font-size:.9em;white-space:nowrap}
        #category-buttons button.active{background-color:#ffd814;border-color:#fcd200;font-weight:bold}
        /* Hinweis-Banner */
        #promo-banner{margin:10px 20px;background:#fff8d6;border:1px solid #fcd200;color:#1c1c1e;padding:10px 12px;border-radius:8px;font-size:.95em}
        main{padding:20px}
        #product-container{display:grid;grid-template-columns:1fr 1fr;gap:15px;text-align:center}
        .product-item{background-color:white;border:1px solid #ddd;border-radius:8px;padding:10px;cursor:pointer;transition:box-shadow .2s;display:flex;flex-direction:column;justify-content:space-between;align-items:center;text-align:left}
        .product-item:hover{box-shadow:0 4px 8px rgba(0,0,0,.1)}
        /* Bild-Wrapper + Ausverkauft-Badge nur über dem Bild */
        .img-wrap{position:relative;width:100%}
        .img-wrap img{display:block;max-width:100%;height:auto;border-radius:5px;margin-bottom:10px}
        .badge-soldout{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.92);color:#c0392b;border:1px solid #e74c3c;padding:6px 10px;border-radius:6px;font-weight:bold;white-space:nowrap}
        .product-item h3{margin:0 0 5px 0;font-size:1em}
        .product-item .rating{display:flex;align-items:center;margin-bottom:5px;font-size:.9em;color:#555}
        .product-item .rating .stars{color:#ffc107}
        .product-item .delivery-info{font-size:.8em;color:#007185;margin-bottom:10px}
        .product-item .price{margin:0 0 10px 0;color:#b12704;font-weight:bold;font-size:1.1em}
        .product-item .order-button{background-color:#ffd814;border:1px solid #fcd200;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:.9em;width:100%}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000}
        .overlay.hidden{display:none}
        .overlay-content{background-color:white;padding:20px;border-radius:8px;width:90%;max-width:400px;position:relative;text-align:center;max-height:90vh;overflow:auto}
        .overlay .close-button-container{position:absolute;top:10px;right:10px;z-index:1001}
        .close-overlay{width:28px;height:28px;font-size:1em;background-color:#ffd814;border:1px solid #fcd200;color:#555;cursor:pointer;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:bold;line-height:1;padding:0}
        .overlay-content h2{margin-top:0}
        .overlay-content button{background-color:#ffd814;border:1px solid #fcd200;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:1em;width:100%;margin-top:15px}
        #account-list-container{max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:5px;padding:10px}
        #account-list button{display:block;width:100%;padding:10px;margin-bottom:10px;background-color:#f7f7f7;border:1px solid #ddd;border-radius:5px;text-align:left;cursor:pointer}
        #security-code-input,#review-comment-input,#my-purchases-code-input,#return-reason-input{width:100%;padding:10px;box-sizing:border-box;margin-top:10px;border:1px solid #ccc;border-radius:5px}
        .error-message{color:red;margin-top:10px;font-size:.9em}
        /* Deaktiviertes Produkt */
        .out-of-stock{opacity:.6;pointer-events:none;position:relative}
        .out-of-stock h3{text-decoration:line-through}
        .stars{display:flex;justify-content:center;margin-top:10px}
        .star{font-size:1.5em;color:#ddd;cursor:pointer}
        .star.filled{color:#ffc107}
        .product-overlay-image{max-width:100%;height:auto;margin-bottom:15px;border-radius:8px}
        #read-reviews-button{margin-top:5px;padding:5px 10px;font-size:.9em;background-color:#f0f0f0;border:1px solid #ccc;color:#555}
        #my-purchases-list li,#reviews-list li{text-align:left;background-color:#f9f9f9;border:1px solid #eee;padding:10px;margin-bottom:10px;border-radius:5px;display:flex;flex-direction:column}
        #my-purchases-list-container{max-height:300px;overflow-y:auto}
        /* Scrollbare Bewertungsansicht */
        #reviews-list{max-height:60vh;overflow-y:auto;padding-right:6px}
        #my-purchases-list button{width:auto;margin-top:5px;padding:5px 10px;font-size:.9em}
        .status-badge{display:inline-block;padding:2px 8px;border-radius:12px;color:white;font-size:.8em;margin-top:5px}
        .status-badge.in-progress{background-color:#2c3e50}
        .status-badge.delivered{background-color:#27ae60}
        .status-badge.rejected{background-color:#c0392b}
        .status-badge.return-pending{background-color:#f39c12}
        .status-badge.return-accepted{background-color:#16a085}
        .status-badge.return-rejected{background-color:#e74c3c}

        /* --- NEU: System-Lock Popup + Countdown --- */
        #system-lock{position:fixed;inset:0;background:rgba(0,0,0,.85);color:#fff;display:none;align-items:center;justify-content:center;z-index:2000}
        #system-lock .box{max-width:820px;margin:0 16px;background:#111;border:2px solid #ef4444;border-radius:14px;padding:24px 28px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.4)}
        #system-lock h2{margin:0 0 12px 0;font-size:36px;line-height:1.2}
        #system-lock p{margin:6px 0 0 0;font-size:20px;opacity:.95}
        #system-lock .count{font-weight:700}
    </style>  
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>  
<body>

    <!-- NEU: System-Lock Overlay -->
    <div id="system-lock" role="dialog" aria-live="assertive" aria-modal="true">
      <div class="box">
        <h2>Der Shop ist nicht verfügbar</h2>
        <p>Das Terminal wurde gesperrt. Du wirst zur Startseite weitergeleitet.</p>
        <p>Weiterleitung in <span class="count" id="lock-count">5</span> Sekunden …</p>
      </div>
    </div>

    <header>
        <h1 id="store-title">Willkommen im Mousecity Store</h1>
        <button id="my-purchases-button">Meine Käufe</button>
    </header><div id="category-buttons"></div>
<div id="promo-banner" class="hidden">
    Wusstest du, dass dass du 1.M$ verdienen kannst, indem du eine Bewertung schreibst? Schreibe jetzt eine Bewertung.
</div>

<main>
    <div id="product-container"></div>
</main>

<div id="product-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <img id="product-overlay-image" class="product-overlay-image" src="" alt="Produktbild">
        <h2 id="product-name"></h2>
        <div id="product-rating-display"></div>
        <p id="product-description"></p>
        <p id="product-price"></p>
        <p id="product-delivery"></p>
        <small id="product-stock"></small>
        <button id="read-reviews-button">Bewertungen lesen</button>
        <button id="buy-button">Jetzt kaufen</button>
    </div>
</div>

<div id="reviews-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2 id="reviews-product-name"></h2>
        <ul id="reviews-list"></ul>
    </div>
</div>

<div id="review-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2 id="review-product-name"></h2>
        <h4>Schreibe eine Bewertung</h4>
        <div class="stars" id="new-review-stars">
            <span class="star" data-value="1">⭐</span>
            <span class="star" data-value="2">⭐</span>
            <span class="star" data-value="3">⭐</span>
            <span class="star" data-value="4">⭐</span>
            <span class="star" data-value="5">⭐</span>
        </div>
        <textarea id="review-comment-input" placeholder="Schreib deine Meinung..."></textarea>
        <button id="submit-review-button">Bewertung abschicken</button>
    </div>
</div>

<div id="account-select-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2 id="account-select-title">Benutzerkonto auswählen:</h2>
        <div id="account-list-container"><div id="account-list"></div></div>
    </div>
</div>

<div id="code-entry-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2>Sicherheitscode eingeben</h2>
        <input type="tel" id="security-code-input" placeholder="Sicherheitscode">
        <button id="confirm-buy-button">Kaufen</button>
        <p id="error-message" class="error-message"></p>
    </div>
</div>

<div id="my-purchases-code-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2>Sicherheitscode eingeben</h2>
        <input type="tel" id="my-purchases-code-input" placeholder="Sicherheitscode">
        <button id="my-purchases-confirm-button">Anzeigen</button>
        <p id="my-purchases-error-message" class="error-message"></p>
    </div>
</div>

<div id="my-purchases-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2>Meine Käufe</h2>
        <div id="my-purchases-list-container"><ul id="my-purchases-list"></ul></div>
    </div>
</div>

<div id="return-request-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2>Rücksendung anfragen</h2>
        <p>Geben Sie den Grund für die Rücksendung an:</p>
        <textarea id="return-reason-input" placeholder="Grund für die Rücksendung..."></textarea>
        <button id="submit-return-request-button">Anfrage absenden</button>
    </div>
</div>

<div id="success-overlay" class="overlay hidden">
    <div class="close-button-container"><button class="close-overlay">×</button></div>
    <div class="overlay-content">
        <h2>Kauf erfolgreich!</h2>
        <p id="success-message"></p>
    </div>
</div>

<script>
    // Firebase
    const firebaseConfigPunkte={apiKey:"DEIN_API_KEY_MUSS_HIER_EINGEFUEGT_WERDEN",databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"};
    const firebaseConfigGesamt={apiKey:"DEIN_API_KEY_MUSS_HIER_EINGEFUEGT_WERDEN",databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app"};
    const appPunkte=firebase.initializeApp(firebaseConfigPunkte,"punkteApp");
    const appGesamt=firebase.initializeApp(firebaseConfigGesamt,"gesamtApp");
    const dbPunkte=appPunkte.database();
    const dbGesamt=appGesamt.database();

    /* NEU: Systemmodus überwachen und sperren */
    (function setupSystemLock(){
      const lockEl=document.getElementById('system-lock');
      const countEl=document.getElementById('lock-count');
      const REDIRECT_URL="https://frederickoeller1207.github.io/terminal/";
      let lockActive=false, tId=null, redirectIn=5;

      // Eingaben blockieren, wenn Lock aktiv
      const capture=(e)=>{ if(lockActive){ e.stopImmediatePropagation(); e.preventDefault(); } };
      ["click","touchstart","pointerdown","keydown","submit"].forEach(t=>document.addEventListener(t,capture,true));

      const startCountdown=()=>{
        redirectIn=5;
        countEl.textContent=String(redirectIn);
        if(tId) clearInterval(tId);
        tId=setInterval(()=>{
          redirectIn-=1;
          countEl.textContent=String(Math.max(0,redirectIn));
          if(redirectIn<=0){
            clearInterval(tId);
            location.replace(REDIRECT_URL);
          }
        },1000);
      };

      const showLock=()=>{
        if(lockActive) return;
        lockActive=true;
        lockEl.style.display='flex';
        startCountdown();
      };

      const hideLock=()=>{
        lockActive=false;
        lockEl.style.display='none';
        if(tId) clearInterval(tId);
      };

      // Abo auf systemmode/state
      dbGesamt.ref("systemmode/state").on("value",snap=>{
        const mode = snap && snap.val() && snap.val().value ? snap.val().value : "green";
        if(mode==="green"){ hideLock(); }
        else { showLock(); } // gelb oder rot
      });
    })();
</script>

<script>
    // Immer-Freitag
    const daysUntilNextFriday=()=>{const t=new Date();const d=t.getDay();const f=5;return (f-d+7)%7};
    const fridayDeliveryTextShort=()=>`Lieferung in ${daysUntilNextFriday()} Tagen`;
    const fridayDeliveryTextLong=()=>`Deine Bestellung wird am Freitag in ${daysUntilNextFriday()} Tagen geliefert.`;

    // Elemente
    const productContainer=document.getElementById('product-container');
    const productOverlay=document.getElementById('product-overlay');
    const reviewsOverlay=document.getElementById('reviews-overlay');
    const reviewOverlay=document.getElementById('review-overlay');
    const accountSelectOverlay=document.getElementById('account-select-overlay');
    const codeEntryOverlay=document.getElementById('code-entry-overlay');
    const myPurchasesCodeOverlay=document.getElementById('my-purchases-code-overlay');
    const myPurchasesOverlay=document.getElementById('my-purchases-overlay');
    const returnRequestOverlay=document.getElementById('return-request-overlay');
    const successOverlay=document.getElementById('success-overlay');

    const productNameElement=document.getElementById('product-name');
    const productRatingDisplay=document.getElementById('product-rating-display');
    const productDescriptionElement=document.getElementById('product-description');
    const productPriceElement=document.getElementById('product-price');
    const productDeliveryElement=document.getElementById('product-delivery');
    const productStockElement=document.getElementById('product-stock');
    const buyButton=document.getElementById('buy-button');
    const productOverlayImage=document.getElementById('product-overlay-image');
    const readReviewsButton=document.getElementById('read-reviews-button');
    const reviewsProductName=document.getElementById('reviews-product-name');
    const reviewsList=document.getElementById('reviews-list');
    const reviewProductName=document.getElementById('review-product-name');
    const newReviewStars=document.getElementById('new-review-stars');
    const reviewCommentInput=document.getElementById('review-comment-input');
    const submitReviewButton=document.getElementById('submit-review-button');
    const accountSelectTitle=document.getElementById('account-select-title');
    const accountList=document.getElementById('account-list');
    const securityCodeInput=document.getElementById('security-code-input');
    const confirmBuyButton=document.getElementById('confirm-buy-button');
    const errorMessage=document.getElementById('error-message');
    const myPurchasesButton=document.getElementById('my-purchases-button');
    const myPurchasesCodeInput=document.getElementById('my-purchases-code-input');
    const myPurchasesConfirmButton=document.getElementById('my-purchases-confirm-button');
    const myPurchasesErrorMessage=document.getElementById('my-purchases-error-message');
    const myPurchasesList=document.getElementById('my-purchases-list');
    const returnReasonInput=document.getElementById('return-reason-input');
    const submitReturnRequestButton=document.getElementById('submit-return-request-button');
    const successMessage=document.getElementById('success-message');
    const categoryButtonsContainer=document.getElementById('category-buttons');
    const promoBanner=document.getElementById('promo-banner');

    let selectedProduct=null,selectedUser=null,selectedRating=0,selectedOrder=null;
    let allProducts={},allCategories={},allReviews={},allOrders={};

    // Promo bis einschließlich 12.
    const updatePromo=()=>{const now=new Date(); if(now.getDate()<=12){promoBanner.classList.remove('hidden')}else{promoBanner.classList.add('hidden')}};

    const hideAllOverlays=()=>{document.querySelectorAll('.overlay').forEach(o=>o.classList.add('hidden'));
        securityCodeInput.value='';myPurchasesCodeInput.value='';errorMessage.textContent='';myPurchasesErrorMessage.textContent='';
        returnReasonInput.value='';selectedRating=0;document.querySelectorAll('#new-review-stars .star').forEach(s=>s.classList.remove('filled'));reviewCommentInput.value=''
    };
    document.querySelectorAll('.close-overlay').forEach(b=>b.addEventListener('click',hideAllOverlays));

    const renderStars=(rating)=>{const full=Math.floor(rating);let h='';for(let i=0;i<5;i++){h+=i<full?'⭐':'☆'}return h};

    const loadCategories=()=>{dbPunkte.ref('kategorien').on('value',snap=>{allCategories=snap.val()||{};renderCategoryButtons()})};

    const renderCategoryButtons=()=> {
        categoryButtonsContainer.innerHTML='';
        const allButton=document.createElement('button');
        allButton.textContent='Alle Produkte';allButton.dataset.category='all';allButton.className='active';
        allButton.addEventListener('click',()=>{filterProducts('all');document.querySelectorAll('#category-buttons button').forEach(btn=>btn.classList.remove('active'));allButton.classList.add('active')});
        categoryButtonsContainer.appendChild(allButton);
        Object.keys(allCategories).forEach(key=>{
            const btn=document.createElement('button');btn.textContent=allCategories[key];btn.dataset.category=key;
            btn.addEventListener('click',()=>{filterProducts(key);document.querySelectorAll('#category-buttons button').forEach(b=>b.classList.remove('active'));btn.classList.add('active')});
            categoryButtonsContainer.appendChild(btn);
        });
        filterProducts('all');
    };

    const filterProducts=(categoryId)=>{
        productContainer.innerHTML='';
        let productsToDisplay=Object.values(allProducts).map(p=>p.product);
        if(categoryId!=='all'){productsToDisplay=productsToDisplay.filter(p=>p.kategorie===categoryId)}
        // Lager zuerst, dann Preis
        productsToDisplay.sort((a,b)=>{
            const aAvail=a.stock>0, bAvail=b.stock>0;
            if(aAvail!==bAvail) return aAvail?-1:1;
            return a.preis-b.preis;
        });
        productsToDisplay.forEach(product=>{
            const productItem=document.createElement('div');
            productItem.className='product-item';
            productItem.dataset.productId=product.id;
            if(product.stock<=0){productItem.classList.add('out-of-stock')}
            const reviewsForProduct=Object.values(allReviews).filter(r=>r.productId===product.id);
            const avg=reviewsForProduct.length?reviewsForProduct.reduce((s,r)=>s+r.rating,0)/reviewsForProduct.length:0;
            const rounded=Math.round(avg);
            const imgHtml=product.image?`
                <div class="img-wrap">
                    <img src="${product.image}" alt="${product.name}">
                    ${product.stock<=0?'<div class="badge-soldout">Momentan nicht verfügbar</div>':''}
                </div>`:'';
            productItem.innerHTML=`
                ${imgHtml}
                <h3>${product.name}</h3>
                <div class="rating"><div class="stars">${renderStars(rounded)}</div> (${reviewsForProduct.length})</div>
                <p class="price">${product.preis} Mausdollar</p>
                <p class="delivery-info">${fridayDeliveryTextShort()}</p>
                <button class="order-button">Bestellen</button>
            `;
            productItem.querySelector('.order-button').addEventListener('click',e=>{
                e.stopPropagation();
                if(product.stock>0){selectedProduct=product;showProductOverlay(selectedProduct)}
            });
            productContainer.appendChild(productItem);
        });
    };

    const loadProducts=()=>{
        const productsRef=dbPunkte.ref('shopartikel');
        const reviewsRef=dbPunkte.ref('bewertungen');
        Promise.all([productsRef.once('value'),reviewsRef.once('value')]).then(([pSnap,rSnap])=>{
            const products=pSnap.val()||{};const reviews=rSnap.val()||{};allProducts={};allReviews=reviews;
            Object.keys(products).forEach(key=>{allProducts[key]={product:{id:key,...products[key]},reviews:reviews}});
            loadCategories();updatePromo();
        }).catch(err=>console.error("Fehler beim Laden:",err));
    };

    const showProductOverlay=(product)=>{
        productNameElement.textContent=product.name;
        productDescriptionElement.textContent=product.beschreibung||'Keine Beschreibung vorhanden.';
        productPriceElement.textContent=`${product.preis} Mausdollar`;
        productDeliveryElement.textContent=fridayDeliveryTextShort();
        productStockElement.textContent=`Verfügbar: ${product.stock}`;
        const reviewsForProduct=Object.values(allReviews).filter(r=>r.productId===product.id);
        const avg=reviewsForProduct.length?reviewsForProduct.reduce((s,r)=>s+r.rating,0)/reviewsForProduct.length:0;
        const rounded=Math.round(avg);
        productRatingDisplay.innerHTML=`<div class="rating"><div class="stars">${renderStars(rounded)}</div> (${reviewsForProduct.length})</div>`;
        if(product.image){productOverlayImage.src=product.image;productOverlayImage.style.display='block'}else{productOverlayImage.style.display='none'}
        if(product.stock>0){buyButton.disabled=false;buyButton.textContent='Jetzt kaufen'}else{buyButton.disabled=true;buyButton.textContent='Momentan nicht verfügbar'}
        readReviewsButton.dataset.productId=product.id;
        productOverlay.classList.remove('hidden');
    };

    readReviewsButton.addEventListener('click',()=>{
        const productId=readReviewsButton.dataset.productId;
        if(productId){hideAllOverlays();showReviewsForProduct(productId)}
    });

    const showReviewsForProduct=(productId)=>{
        const product=Object.values(allProducts).find(p=>p.product.id===productId)?.product;
        reviewsList.innerHTML='';reviewsProductName.textContent=`Bewertungen für ${product.name}`;
        const reviewsForProduct=Object.values(allReviews).filter(r=>r.productId===productId);
        if(reviewsForProduct.length>0){
            reviewsForProduct.forEach(r=>{
                const li=document.createElement('li');
                li.innerHTML=`<strong>${renderStars(r.rating)}</strong><br><em>"${r.comment}"</em><br><small>von ${r.userName} am ${new Date(r.date).toLocaleDateString()}</small>`;
                reviewsList.appendChild(li);
            });
        }else{reviewsList.innerHTML='<p>Noch keine Bewertungen.</p>'}
        reviewsOverlay.classList.remove('hidden');
    };

    buyButton.addEventListener('click',()=>{productOverlay.classList.add('hidden');loadUserAccountsForPurchase()});

    // Meine Käufe
    myPurchasesButton.addEventListener('click',()=>{hideAllOverlays();accountSelectTitle.textContent='Benutzerkonto auswählen:';loadUserAccountsForPurchases()});

    myPurchasesConfirmButton.addEventListener('click',()=>{
        const enteredCode=myPurchasesCodeInput.value;
        if(!enteredCode){myPurchasesErrorMessage.textContent='Bitte Sicherheitscode eingeben.';return}
        const codeRef=dbGesamt.ref(`kinder/${selectedUser.name}/code`);
        codeRef.once('value',snap=>{
            const correctCode=snap.val();
            if(enteredCode===correctCode){myPurchasesCodeOverlay.classList.add('hidden');loadPurchases(selectedUser.name)}
            else{myPurchasesErrorMessage.textContent='Falscher Sicherheitscode.'}
        });
    });

    const loadPurchases=(userName)=>{
        myPurchasesList.innerHTML='';const ordersRef=dbPunkte.ref('bestellungen');
        ordersRef.once('value').then(ordersSnapshot=>{
            allOrders=ordersSnapshot.val()||{};
            const userPurchases=Object.keys(allOrders).filter(k=>allOrders[k].name===userName).map(k=>({id:k,...allOrders[k]}));
            const userReviews=Object.values(allReviews).filter(r=>r.userName===userName);
            if(userPurchases.length>0){
                userPurchases.forEach(purchase=>{
                    const li=document.createElement('li');
                    const hasRated=userReviews.some(r=>r.productName===purchase.artikel);
                    const returnStatus=purchase.returnStatus||'keine Anfrage';
                    const orderStatus=purchase.status||'wird geliefert';
                    let returnStatusBadge='',orderStatusBadge='',showReturnButton=true;
                    switch(orderStatus){
                        case'wird geliefert':orderStatusBadge=`<span class="status-badge in-progress">Wird geliefert</span>`;showReturnButton=false;break;
                        case'Produkt geliefert':orderStatusBadge=`<span class="status-badge delivered">Geliefert</span>`;break;
                        case'Kauf abgelehnt':orderStatusBadge=`<span class="status-badge rejected">Kauf abgelehnt</span>`;showReturnButton=false;break;
                    }
                    if(returnStatus!=='keine Anfrage'){
                        switch(returnStatus){
                            case'in Bearbeitung':returnStatusBadge=`<span class="status-badge return-pending">Rücksendung: in Bearbeitung</span>`;showReturnButton=false;break;
                            case'angenommen':returnStatusBadge=`<span class="status-badge return-accepted">Rücksendung: angenommen</span>`;showReturnButton=false;break;
                            case'abgelehnt':returnStatusBadge=`<span class="status-badge return-rejected">Rücksendung: abgelehnt</span>`;showReturnButton=false;break;
                        }
                    }
                    li.innerHTML=`
                        <span><strong>Produkt:</strong> ${purchase.artikel}</span>
                        <span><strong>Kaufdatum:</strong> ${new Date(purchase.kaufdatum).toLocaleDateString()}</span>
                        <span><strong>Gezahlter Preis:</strong> ${purchase.gezahlterPreis} Mausdollar</span>
                        ${orderStatusBadge}
                        ${returnStatusBadge}
                    `;
                    if(orderStatus==='Produkt geliefert'&&!hasRated){
                        const rateButton=document.createElement('button');rateButton.textContent='Bewerten';
                        rateButton.addEventListener('click',()=>{showReviewOverlayForPurchase(purchase.artikel)});li.appendChild(rateButton);
                    }else if(hasRated){
                        const deleteReviewButton=document.createElement('button');deleteReviewButton.textContent='Bewertung löschen';
                        deleteReviewButton.style.backgroundColor='red';deleteReviewButton.style.borderColor='darkred';
                        deleteReviewButton.addEventListener('click',()=>{deleteReview(purchase.artikel,userName)});li.appendChild(deleteReviewButton);
                    }
                    if(showReturnButton){
                        const returnButton=document.createElement('button');returnButton.textContent='Rücksendung anfragen';
                        returnButton.addEventListener('click',()=>{showReturnRequestOverlay(purchase)});li.appendChild(returnButton);
                    }
                    myPurchasesList.appendChild(li);
                });
            }else{myPurchasesList.innerHTML='<li>Sie haben noch keine Produkte gekauft.</li>'}
            myPurchasesOverlay.classList.remove('hidden');
        });
    };

    const deleteReview=(productName,userName)=>{
        const reviewsRef=dbPunkte.ref('bewertungen');
        reviewsRef.orderByChild('userName').equalTo(userName).once('value',snapshot=>{
            const reviews=snapshot.val();
            if(reviews){
                const key=Object.keys(reviews).find(k=>reviews[k].productName===productName);
                if(key){dbPunkte.ref(`bewertungen/${key}`).remove().then(()=>{alert('Bewertung erfolgreich gelöscht!');hideAllOverlays();loadProducts();loadPurchases(userName)}).catch(()=>alert('Fehler beim Löschen der Bewertung.'))}
            }
        });
    };

    const showReviewOverlayForPurchase=(productName)=>{
        hideAllOverlays();reviewProductName.textContent=productName;
        const product=Object.values(allProducts).find(p=>p.product.name===productName)?.product;
        if(product){selectedProduct=product;reviewOverlay.classList.remove('hidden')}else{alert('Produkt nicht gefunden.')}
    };

    const showReturnRequestOverlay=(purchase)=>{hideAllOverlays();selectedOrder=purchase;returnRequestOverlay.classList.remove('hidden')};

    submitReturnRequestButton.addEventListener('click',()=>{
        const reason=returnReasonInput.value.trim();
        if(!reason){alert('Bitte geben Sie einen Grund für die Rücksendung an.');return}
        const ref=dbPunkte.ref('ruecksendeanfragen').push();
        ref.set({orderId:selectedOrder.id,userName:selectedOrder.name,userType:selectedUser.type,productName:selectedOrder.artikel,purchasePrice:selectedOrder.gezahlterPreis,reason,date:new Date().toISOString()})
        .then(()=>{dbPunkte.ref(`bestellungen/${selectedOrder.id}/returnStatus`).set('in Bearbeitung');alert('Rückgabeanfrage wurde gesendet.');hideAllOverlays();loadPurchases(selectedUser.name)})
        .catch(()=>alert('Fehler beim Senden der Rückgabeanfrage.'));
    });

    submitReviewButton.addEventListener('click',()=>{
        const comment=reviewCommentInput.value.trim();const productId=selectedProduct.id;
        if(selectedRating===0){alert('Bitte wähle eine Stern-Bewertung aus.');return}
        if(!comment){alert('Bitte gib einen Kommentar ein.');return}
        const newRef=dbPunkte.ref('bewertungen').push();
        newRef.set({productId,productName:selectedProduct.name,userName:selectedUser.name,rating:selectedRating,comment,date:new Date().toISOString()})
        .then(()=>{alert('Bewertung erfolgreich abgegeben!');hideAllOverlays();loadProducts();loadPurchases(selectedUser.name)})
        .catch(()=>alert('Fehler beim Speichern der Bewertung.'));
    });

    newReviewStars.addEventListener('click',e=>{
        if(e.target.classList.contains('star')){
            selectedRating=parseInt(e.target.dataset.value);
            document.querySelectorAll('#new-review-stars .star').forEach(star=>{parseInt(star.dataset.value)<=selectedRating?star.classList.add('filled'):star.classList.remove('filled')});
        }
    });

    const loadUserAccountsForPurchase=()=>{
        accountSelectTitle.textContent='Benutzerkonto auswählen:';accountList.innerHTML='';
        const kinderRef=dbPunkte.ref('kinder');const auslandRef=dbPunkte.ref('auslandskonten');
        Promise.all([kinderRef.once('value'),auslandRef.once('value')]).then(([kSnap,aSnap])=>{
            const accounts={};const kinder=kSnap.val()||{};Object.keys(kinder).forEach(n=>{accounts[n]={...kinder[n],type:'kinder'}});
            const ausland=aSnap.val()||{};Object.keys(ausland).forEach(n=>{accounts[n]={...ausland[n],type:'auslandskonten'}});
            const names=Object.keys(accounts).sort();
            if(names.length>0){
                names.forEach(name=>{
                    const acc=accounts[name];const btn=document.createElement('button');btn.textContent=`${name} (${acc.punkte} Mausdollar)`;
                    btn.addEventListener('click',()=>{selectedUser={name,punkte:acc.punkte,type:acc.type};accountSelectOverlay.classList.add('hidden');codeEntryOverlay.classList.remove('hidden');document.getElementById('security-code-input').focus()});
                    accountList.appendChild(btn);
                });
                accountSelectOverlay.classList.remove('hidden');
            }else{alert('Keine Konten gefunden.')}
        }).catch(()=>alert('Fehler beim Laden der Konten.'));
    };

    const loadUserAccountsForPurchases=()=>{
        accountSelectTitle.textContent='Benutzerkonto für Käufe auswählen:';accountList.innerHTML='';
        const kinderRef=dbPunkte.ref('kinder');const auslandRef=dbPunkte.ref('auslandskonten');
        Promise.all([kinderRef.once('value'),auslandRef.once('value')]).then(([kSnap,aSnap])=>{
            const accounts={};const kinder=kSnap.val()||{};Object.keys(kinder).forEach(n=>{accounts[n]={...kinder[n],type:'kinder'}});
            const ausland=aSnap.val()||{};Object.keys(ausland).forEach(n=>{accounts[n]={...ausland[n],type:'auslandskonten'}});
            const names=Object.keys(accounts).sort();
            if(names.length>0){
                names.forEach(name=>{
                    const btn=document.createElement('button');btn.textContent=name;
                    btn.addEventListener('click',()=>{selectedUser={name,punkte:accounts[name].punkte,type:accounts[name].type};accountSelectOverlay.classList.add('hidden');myPurchasesCodeOverlay.classList.remove('hidden');document.getElementById('my-purchases-code-input').focus()});
                    accountList.appendChild(btn);
                });
                accountSelectOverlay.classList.remove('hidden');
            }else{alert('Keine Konten gefunden.')}
        }).catch(()=>alert('Fehler beim Laden der Konten.'));
    };

    confirmBuyButton.addEventListener('click',()=>{
        const enteredCode=securityCodeInput.value;
        if(!enteredCode){errorMessage.textContent='Bitte Sicherheitscode eingeben.';return}
        const codeRef=dbGesamt.ref(`kinder/${selectedUser.name}/code`);
        codeRef.once('value',snapshot=>{
            const correctCode=snapshot.val();
            if(enteredCode===correctCode){
                if(selectedUser.punkte>=selectedProduct.preis){
                    const newPoints=selectedUser.punkte-selectedProduct.preis;
                    const newStock=selectedProduct.stock-1;
                    const updates={};
                    updates[`${selectedUser.type}/${selectedUser.name}/punkte`]=newPoints;
                    updates[`shopartikel/${selectedProduct.id}/stock`]=newStock;
                    dbPunkte.ref().update(updates).then(()=>{
                        const newOrderRef=dbPunkte.ref('bestellungen').push();
                        newOrderRef.set({
                            name:selectedUser.name,artikel:selectedProduct.name,lieferzeit:selectedProduct.lieferzeit,
                            kaufdatum:new Date().toISOString(),gezahlterPreis:selectedProduct.preis,status:'wird geliefert',userType:selectedUser.type
                        }).then(()=>{
                            codeEntryOverlay.classList.add('hidden');
                            successMessage.textContent=`Vielen Dank für deinen Einkauf! ${fridayDeliveryTextLong()}`;
                            successOverlay.classList.remove('hidden');loadProducts();
                        });
                    }).catch(()=>{errorMessage.textContent='Ein Fehler ist aufgetreten. Bitte versuche es erneut.'});
                }else{errorMessage.textContent='Zu wenige Punkte für diesen Kauf.'}
            }else{errorMessage.textContent='Falscher Sicherheitscode.'}
        });
    });

    document.addEventListener('DOMContentLoaded',loadProducts);
</script>

<script>
  if('serviceWorker'in navigator){
    window.addEventListener('load',()=>{navigator.serviceWorker.register('service-worker.js').catch(console.error)});
  }
</script>

</body>
</html>