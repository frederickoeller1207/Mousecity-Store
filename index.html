<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Willkommen im Maus-City Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    header {
      padding: 10px 16px;
      background: #232f3e;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header button {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 16px;
      justify-content: center;
    }
    .product {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 12px;
      width: calc(50% - 20px);
      box-sizing: border-box;
      cursor: pointer;
    }
    .product h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .overlay, .select-user, .enter-code {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .overlay-content {
      background: white;
      padding: 20px;
      max-width: 300px;
      width: 100%;
      border-radius: 10px;
      position: relative;
    }
    .overlay-content h2 {
      margin-top: 0;
    }
    .overlay-content button.close {
      position: absolute;
      right: 10px;
      top: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .user-list button, .buy-button {
      display: block;
      margin: 8px auto;
      padding: 8px 12px;
      background: #ff9900;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      color: white;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .message {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Willkommen im Maus-City Store</h1>
    <button onclick="openAdmin()">a</button>
  </header>

  <div class="grid" id="productGrid"></div>

  <div class="overlay" id="productOverlay">
    <div class="overlay-content">
      <button class="close" onclick="closeOverlay()">×</button>
      <h2 id="productName"></h2>
      <p id="productDescription"></p>
      <p id="productLieferzeit"></p>
      <button onclick="openUserSelect()">Jetzt kaufen</button>
    </div>
  </div>

  <div class="overlay select-user" id="userOverlay">
    <div class="overlay-content">
      <button class="close" onclick="closeUserOverlay()">×</button>
      <h3>Bitte Benutzerkonto auswählen</h3>
      <div class="user-list" id="userList"></div>
    </div>
  </div>

  <div class="overlay enter-code" id="codeOverlay">
    <div class="overlay-content">
      <button class="close" onclick="closeCodeOverlay()">×</button>
      <h3>Sicherheitscode eingeben</h3>
      <input type="password" id="codeInput" placeholder="Code">
      <button class="buy-button" onclick="confirmPurchase()">Kaufen</button>
      <div class="message" id="codeMessage"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, set, get, child, update, push
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const app1 = initializeApp({
      databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
    }, "punkte");

    const app2 = initializeApp({
      databaseURL: "https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app"
    }, "gesamt");

    const db1 = getDatabase(app1);
    const db2 = getDatabase(app2);

    const productGrid = document.getElementById("productGrid");
    const productOverlay = document.getElementById("productOverlay");
    const productName = document.getElementById("productName");
    const productDescription = document.getElementById("productDescription");
    const productLieferzeit = document.getElementById("productLieferzeit");

    const userOverlay = document.getElementById("userOverlay");
    const userList = document.getElementById("userList");

    const codeOverlay = document.getElementById("codeOverlay");
    const codeInput = document.getElementById("codeInput");
    const codeMessage = document.getElementById("codeMessage");

    let selectedProduct = null;
    let selectedUser = null;

    function closeOverlay() {
      productOverlay.style.display = "none";
    }

    function closeUserOverlay() {
      userOverlay.style.display = "none";
    }

    function closeCodeOverlay() {
      codeOverlay.style.display = "none";
      codeInput.value = "";
      codeMessage.textContent = "";
    }

    function openAdmin() {
      const code = prompt("Admin-Code:");
      if (code === "121071") location.href = "admin.html";
    }

    function openUserSelect() {
      userList.innerHTML = "";
      selectedUser = null;
      userOverlay.style.display = "flex";

      const pfade = ["kinder", "auslandskonten"];
      pfade.forEach(pfad => {
        const refPath = ref(db1, pfad);
        onValue(refPath, snapshot => {
          if (!snapshot.exists()) return;
          Object.entries(snapshot.val()).forEach(([name, data]) => {
            const btn = document.createElement("button");
            btn.textContent = `${name} (${data.punkte || 0})`;
            btn.onclick = () => {
              selectedUser = { name, pfad };
              closeUserOverlay();
              codeOverlay.style.display = "flex";
            };
            userList.appendChild(btn);
          });
        }, { onlyOnce: true });
      });
    }

    function confirmPurchase() {
      const code = codeInput.value.trim();
      if (!selectedUser || !selectedProduct) return;

      const codeRef = ref(db2, `kinder/${selectedUser.name}/code`);
      get(codeRef).then(snap => {
        if (!snap.exists() || snap.val() !== code) {
          codeMessage.textContent = "❌ Code falsch.";
          return;
        }

        const punkteRef = ref(db1, `${selectedUser.pfad}/${selectedUser.name}/punkte`);
        get(punkteRef).then(pSnap => {
          const punkte = pSnap.val() || 0;
          if (punkte < selectedProduct.preis) {
            codeMessage.textContent = "❌ Nicht genug Punkte.";
            return;
          }

          const newPunkte = punkte - selectedProduct.preis;
          set(punkteRef, newPunkte);

          const newOrder = {
            name: selectedUser.name,
            artikel: selectedProduct.name,
            lieferzeit: selectedProduct.lieferzeit || ""
          };
          const bestellRef = push(ref(db1, "bestellungen"));
          set(bestellRef, newOrder);

          codeMessage.textContent = `✔️ Bestellt! ${selectedProduct.lieferzeit || ""}`;
          setTimeout(() => {
            closeCodeOverlay();
            closeOverlay();
          }, 1500);
        });
      });
    }

    function showProductDetails(prod) {
      selectedProduct = prod;
      productName.textContent = prod.name;
      productDescription.textContent = prod.beschreibung || "";
      productLieferzeit.textContent = prod.lieferzeit || "";
      productOverlay.style.display = "flex";
    }

    const produktRef = ref(db1, "shopartikel");
    onValue(produktRef, snapshot => {
      productGrid.innerHTML = "";
      const produkte = Object.values(snapshot.val() || {});
      produkte.sort((a, b) => (a.preis || 0) - (b.preis || 0));
      produkte.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `<h3>${p.name}</h3><p>${p.preis} Maus$</p><p>${p.lieferzeit || ""}</p>`;
        div.onclick = () => showProductDetails(p);
        productGrid.appendChild(div);
      });
    });
  </script>
</body>
</html>