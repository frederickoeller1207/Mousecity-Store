<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Maus-City Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f2f2f2;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #007aff;
      color: white;
      padding: 12px 20px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    .admin-btn {
      background: white;
      color: #007aff;
      border: none;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      padding: 16px;
    }
    .card {
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    .card h3 {
      margin: 0 0 6px;
      font-size: 16px;
    }
    .card p {
      margin: 2px 0;
      font-size: 14px;
    }
    #detail, #admin {
      display: none;
      padding: 20px;
    }
    .back-btn {
      margin-top: 20px;
      background: #007aff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
    }
    .buy-btn {
      margin-top: 14px;
      background: green;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
    }
    .hidden { display: none; }
    input, textarea {
      width: 100%;
      padding: 6px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 6px;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .x-btn {
      color: red;
      margin-left: 10px;
      cursor: pointer;
    }
    .order-box {
      margin-bottom: 10px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Maus-City Store</h1>
    <button class="admin-btn" onclick="adminLogin()">a</button>
  </header>

  <div id="main" class="grid"></div>

  <div id="detail"></div>

  <div id="admin"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove, update, push, get } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const app = initializeApp({
      apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      authDomain: "punkte-45c20.firebaseapp.com",
      databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "punkte-45c20",
    });

    const db = getDatabase(app);
    const main = document.getElementById("main");
    const detail = document.getElementById("detail");
    const admin = document.getElementById("admin");

    let artikel = {};
    let aktiveArtikelId = null;

    function showMain() {
      detail.style.display = "none";
      admin.style.display = "none";
      main.style.display = "grid";
    }

    function showDetail(id) {
      const a = artikel[id];
      aktiveArtikelId = id;
      main.style.display = "none";
      detail.style.display = "block";
      detail.innerHTML = `
        <h2>${a.name}</h2>
        <p><b>Preis:</b> ${a.preis} Mausdollar</p>
        <p><b>Lieferzeit:</b> ${a.lieferzeit}</p>
        <p><b>Beschreibung:</b><br>${a.beschreibung}</p>
        <p><b>Auf Lager:</b> ${a.stock > 0 ? a.stock : "<span style='color:red'>ausverkauft</span>"}</p>
        <button class="buy-btn" onclick="starteKauf()">Jetzt kaufen</button>
        <button class="back-btn" onclick="showMain()">Zurück</button>
      `;
    }

    function ladeArtikel() {
      onValue(ref(db, "shopartikel"), snap => {
        artikel = snap.val() || {};
        main.innerHTML = "";
        Object.entries(artikel)
          .sort((a, b) => a[1].preis - b[1].preis)
          .forEach(([id, a]) => {
            const div = document.createElement("div");
            div.className = "card";
            div.onclick = () => showDetail(id);
            div.innerHTML = `
              <h3>${a.name}</h3>
              <p>${a.preis} Mausdollar</p>
              <p>${a.stock > 0 ? `Auf Lager: ${a.stock}` : "<span style='color:red'>Ausverkauft</span>"}</p>
            `;
            main.appendChild(div);
          });
      });
    }

    window.onload = () => {
      ladeArtikel();
    };
};

    window.starteKauf = async function () {
      const name = prompt("Welches Konto soll kaufen?");
      if (!name) return;
      const pinSnap = await get(ref(db, "kinder/" + name));
      if (!pinSnap.exists()) return alert("Konto nicht gefunden.");
      const punkteInfo = pinSnap.val();
      const adminSnap = await get(ref(getDatabase(initializeApp({
        apiKey: "AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
        authDomain: "gesamt-dae4e.firebaseapp.com",
        databaseURL: "https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "gesamt-dae4e"
      }, "app2")), "kinder/" + name));
      if (!adminSnap.exists()) return alert("Code nicht gefunden.");
      const richtigerCode = adminSnap.val().code;
      const eingegeben = prompt("Bitte Sicherheitscode eingeben:");
      if (eingegeben !== richtigerCode) return alert("Falscher Code.");
      const a = artikel[aktiveArtikelId];
      if (punkteInfo.punkte < a.preis) return alert("Du hast leider zu wenig Mausdollar.");
      const neuePunkte = punkteInfo.punkte - a.preis;
      await update(ref(db, "kinder/" + name), { punkte: neuePunkte });
      await push(ref(db, "bestellungen"), {
        name,
        artikel: a.name,
        lieferzeit: a.lieferzeit,
        zeit: new Date().toISOString()
      });
      await update(ref(db, "shopartikel/" + aktiveArtikelId), {
        stock: (a.stock || 0) - 1
      });
      alert(`Erfolgreich bestellt!\nVoraussichtliche Lieferung: ${a.lieferzeit}`);
      showMain();
    };

    window.adminLogin = function () {
      const eingabe = prompt("Admin Code:");
      if (eingabe === "121071") {
        zeigeAdmin();
      } else {
        alert("Falscher Code.");
      }
    }

    function zeigeAdmin() {
      main.style.display = "none";
      detail.style.display = "none";
      admin.style.display = "block";
      admin.innerHTML = "<h2>Admin – Shopverwaltung</h2>";

      // Bestellungen anzeigen
      const bestellBox = document.createElement("div");
      bestellBox.className = "section";
      bestellBox.innerHTML = "<h3>Bestellungen</h3>";
      onValue(ref(db, "bestellungen"), snap => {
        bestellBox.innerHTML = "<h3>Bestellungen</h3>";
        snap.forEach(child => {
          const d = child.val();
          const div = document.createElement("div");
          div.className = "order-box";
          div.innerHTML = `<b>${d.name}</b> hat <i>${d.artikel}</i> bestellt. Lieferung: ${d.lieferzeit} 
            <span class="x-btn" onclick="loescheBestellung('${child.key}')">x</span>`;
          bestellBox.appendChild(div);
        });
      });
      admin.appendChild(bestellBox);

      // Formular zum Hinzufügen
      const form = document.createElement("div");
      form.innerHTML = `
        <h3>Neues Produkt</h3>
        <input id="name" placeholder="Name" />
        <input id="preis" placeholder="Preis" type="number" />
        <input id="lieferzeit" placeholder="Lieferzeit" />
        <input id="stock" placeholder="Lagerbestand" type="number" />
        <textarea id="beschreibung" placeholder="Beschreibung"></textarea>
        <button onclick="produktSpeichern()">Speichern</button>
      `;
      admin.appendChild(form);

      // Bestehende Produkte
      const liste = document.createElement("div");
      liste.innerHTML = "<h3>Produkte bearbeiten</h3>";
      onValue(ref(db, "shopartikel"), snap => {
        liste.innerHTML = "<h3>Produkte bearbeiten</h3>";
        snap.forEach(child => {
          const id = child.key;
          const d = child.val();
          const box = document.createElement("div");
          box.className = "order-box";
          box.innerHTML = `
            <b>${d.name}</b> – ${d.preis} MD – Lager: ${d.stock} <br>
            <small>${d.beschreibung}</small><br>
            <button onclick="bearbeiten('${id}')">Bearbeiten</button>
            <span class="x-btn" onclick="loescheArtikel('${id}')">x</span>
          `;
          liste.appendChild(box);
        });
      });
      admin.appendChild(liste);
    }

    window.produktSpeichern = async function () {
      const name = document.getElementById("name").value;
      const preis = +document.getElementById("preis").value;
      const lieferzeit = document.getElementById("lieferzeit").value;
      const stock = +document.getElementById("stock").value;
      const beschreibung = document.getElementById("beschreibung").value;
      if (!name || !beschreibung || !lieferzeit || !preis || !stock) return alert("Felder fehlen");
      const neu = { name, preis, lieferzeit, beschreibung, stock };
      await push(ref(db, "shopartikel"), neu);
      alert("Gespeichert.");
    };

    window.bearbeiten = async function (id) {
      const d = artikel[id];
      document.getElementById("name").value = d.name;
      document.getElementById("preis").value = d.preis;
      document.getElementById("lieferzeit").value = d.lieferzeit;
      document.getElementById("stock").value = d.stock;
      document.getElementById("beschreibung").value = d.beschreibung;
      await remove(ref(db, "shopartikel/" + id));
    }

    window.loescheArtikel = function(id) {
      if (confirm("Löschen?")) remove(ref(db, "shopartikel/" + id));
    }

    window.loescheBestellung = function(id) {
      if (confirm("Bestellung löschen?")) remove(ref(db, "bestellungen/" + id));
    }
  </script>
</body>
</html>