<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maus-City Store</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #232f3e;
      color: white;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    #admin-button {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    .product-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 16px;
    }
    .product {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .product-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
    }
    .product-price {
      color: #b12704;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .product-lieferzeit {
      font-size: 12px;
      color: #555;
      margin-bottom: 10px;
    }
    .product button {
      background: #ffa41c;
      border: none;
      padding: 10px;
      font-weight: bold;
      color: #111;
      border-radius: 6px;
      cursor: pointer;
    }
    .overlay, .admin-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal, .admin-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }
    .modal h2, .admin-panel h2 {
      margin-top: 0;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .konto-btn {
      display: block;
      padding: 10px;
      background: #e7e7e7;
      margin-bottom: 8px;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
    }
    input, textarea {
      width: 100%;
      margin: 6px 0 12px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button.save-btn {
      background: #007aff;
      color: white;
    }
    .bestellung {
      padding: 10px;
      background: #f0f0f0;
      margin-bottom: 6px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .bestellung button {
      background: red;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Maus-City Store</h1>
    <button id="admin-button">a</button>
  </header>
  <div class="product-list" id="product-list"></div>

  <!-- Produkt-Overlay -->
  <div class="overlay" id="product-overlay">
    <div class="modal" id="product-modal">
      <button class="close-btn" onclick="closeOverlay()">√ó</button>
      <h2 id="modal-name"></h2>
      <p class="product-price" id="modal-preis"></p>
      <p class="product-lieferzeit" id="modal-lieferzeit"></p>
      <p id="modal-beschreibung"></p>
      <button onclick="startKauf()">Jetzt kaufen</button>
    </div>
  </div>

  <!-- Kontenauswahl -->
  <div class="overlay" id="konto-overlay">
    <div class="modal">
      <button class="close-btn" onclick="closeOverlay()">√ó</button>
      <h2>Bitte Benutzerkonto ausw√§hlen</h2>
      <div id="konto-liste"></div>
    </div>
  </div>

  <!-- Code-Eingabe -->
  <div class="overlay" id="code-overlay">
    <div class="modal">
      <button class="close-btn" onclick="closeOverlay()">√ó</button>
      <h2>Code eingeben</h2>
      <input type="number" id="code-input" placeholder="Sicherheitscode" />
      <button onclick="kaufBestaetigen()">Kaufen</button>
    </div>
  </div>

  <!-- Adminbereich -->
  <div class="admin-overlay" id="admin-overlay">
    <div class="admin-panel">
      <button class="close-btn" onclick="document.getElementById('admin-overlay').style.display='none'">√ó</button>
      <h2>üõí Admin-Bereich</h2>
      <div id="bestell√ºbersicht"></div>
      <hr/>
      <input id="artikel-id" type="text" placeholder="(Nur beim Bearbeiten)" />
      <input id="artikel-name" type="text" placeholder="Produktname" />
      <input id="artikel-preis" type="number" placeholder="Preis in Mausdollar" />
      <input id="artikel-lieferzeit" type="text" placeholder="Lieferzeit z.‚ÄØB. '2‚Äì3 Tage'" />
      <textarea id="artikel-beschreibung" placeholder="Beschreibung" rows="3"></textarea>
      <button class="save-btn" onclick="speichern()">Speichern</button>
      <h3>Produkte</h3>
      <div id="artikel-liste"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import {
    getDatabase, ref, onValue, set, remove, get, child
  } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  const app = initializeApp({
    apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
    authDomain: "punkte-45c20.firebaseapp.com",
    databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "punkte-45c20"
  });

  const db = getDatabase(app);
  const punkteRef = ref(db, "kinder");
  const auslandRef = ref(db, "auslandskonten");
  const shopRef = ref(db, "shopartikel");
  const bestellungenRef = ref(db, "bestellungen");

  let aktuellesProdukt = null;
  let aktuellesKind = null;

  const produktContainer = document.getElementById("product-list");

  function renderProdukte() {
    onValue(shopRef, snap => {
      produktContainer.innerHTML = "";
      const produkte = [];
      snap.forEach(child => produkte.push({ id: child.key, ...child.val() }));
      produkte.sort((a, b) => a.preis - b.preis);
      produkte.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <div class="product-name">${p.name}</div>
          <div class="product-price">${p.preis} Mausdollar</div>
          <div class="product-lieferzeit">${p.lieferzeit || ""}</div>
          <button onclick='showProdukt(${JSON.stringify(p)})'>Ansehen</button>
        `;
        produktContainer.appendChild(div);
      });
    });
  }

  window.showProdukt = (produkt) => {
    aktuellesProdukt = produkt;
    document.getElementById("modal-name").innerText = produkt.name;
    document.getElementById("modal-preis").innerText = `${produkt.preis} Mausdollar`;
    document.getElementById("modal-lieferzeit").innerText = produkt.lieferzeit || "";
    document.getElementById("modal-beschreibung").innerText = produkt.beschreibung || "";
    document.getElementById("product-overlay").style.display = "flex";
  };

  window.closeOverlay = () => {
    document.querySelectorAll(".overlay").forEach(el => el.style.display = "none");
  };

  window.startKauf = () => {
    closeOverlay();
    document.getElementById("konto-overlay").style.display = "flex";
    const liste = document.getElementById("konto-liste");
    liste.innerHTML = "";
    const anzeigen = (snap) => {
      snap.forEach(child => {
        const name = child.key;
        const konto = document.createElement("div");
        konto.className = "konto-btn";
        konto.innerText = name;
        konto.onclick = () => {
          aktuellesKind = name;
          closeOverlay();
          document.getElementById("code-overlay").style.display = "flex";
        };
        liste.appendChild(konto);
      });
    };
    onValue(punkteRef, anzeigen, { onlyOnce: true });
    onValue(auslandRef, anzeigen, { onlyOnce: true });
  };

  window.kaufBestaetigen = async () => {
    const code = document.getElementById("code-input").value.trim();
    if (!code) return alert("Bitte Code eingeben");

    const codeSnap = await get(ref(db, "kinder/" + aktuellesKind + "/code"));
    const auslSnap = await get(ref(db, "auslandskonten/" + aktuellesKind + "/code"));

    const richtigerCode = codeSnap.exists() ? codeSnap.val() : auslSnap.exists() ? auslSnap.val() : null;

    if (code != richtigerCode) return alert("Falscher Code");

    const punktSnap = await get(ref(db, "kinder/" + aktuellesKind + "/punkte"));
    const auslPunkte = await get(ref(db, "auslandskonten/" + aktuellesKind + "/punkte"));
    const punkte = punktSnap.exists() ? punktSnap.val() : auslPunkte.exists() ? auslPunkte.val() : 0;

    if (punkte < aktuellesProdukt.preis) {
      alert("Du hast leider zu wenig Mausdollar.");
      return closeOverlay();
    }

    const ziel = punktSnap.exists()
      ? ref(db, "kinder/" + aktuellesKind + "/punkte")
      : ref(db, "auslandskonten/" + aktuellesKind + "/punkte");

    await set(ziel, punkte - aktuellesProdukt.preis);
    await set(ref(db, "bestellungen/" + Date.now()), {
      name: aktuellesKind,
      artikel: aktuellesProdukt.name,
      lieferzeit: aktuellesProdukt.lieferzeit || ""
    });

    alert(`Erfolgreich bestellt. Voraussichtliche Lieferung: ${aktuellesProdukt.lieferzeit || "bald"}`);
    closeOverlay();
  };

  // Admin-Login
  document.getElementById("admin-button").onclick = () => {
    const code = prompt("Admin-Code:");
    if (code === "121071") {
      document.getElementById("admin-overlay").style.display = "flex";
    }
  };

  const artikelListe = document.getElementById("artikel-liste");
  const bestell√ºbersicht = document.getElementById("bestell√ºbersicht");

  onValue(shopRef, snap => {
    artikelListe.innerHTML = "";
    snap.forEach(child => {
      const art = child.val();
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        <div>
          <strong>${art.name}</strong><br/>
          ${art.preis} Mausdollar ‚Äì ${art.lieferzeit || "keine Angabe"}
        </div>
        <button onclick="bearbeiten('${child.key}', '${art.name}', '${art.preis}', '${art.lieferzeit || ""}', \`${art.beschreibung || ""}\`)">‚úèÔ∏è</button>
        <button onclick="remove(ref(db, 'shopartikel/${child.key}'))">x</button>
      `;
      artikelListe.appendChild(div);
    });
  });

  onValue(bestellungenRef, snap => {
    bestell√ºbersicht.innerHTML = "";
    snap.forEach(child => {
      const b = child.val();
      const div = document.createElement("div");
      div.className = "bestellung";
      div.innerHTML = `
        <div><strong>${b.name}</strong> hat <em>${b.artikel}</em> bestellt<br/><small>${b.lieferzeit || "Lieferzeit unbekannt"}</small></div>
        <button onclick="remove(ref(db, 'bestellungen/${child.key}'))">x</button>
      `;
      bestell√ºbersicht.appendChild(div);
    });
  });

  window.speichern = () => {
    const id = document.getElementById("artikel-id").value.trim() || Date.now();
    const name = document.getElementById("artikel-name").value.trim();
    const preis = parseInt(document.getElementById("artikel-preis").value);
    const lieferzeit = document.getElementById("artikel-lieferzeit").value.trim();
    const beschreibung = document.getElementById("artikel-beschreibung").value.trim();

    if (!name || isNaN(preis)) {
      alert("Name und Preis sind Pflicht.");
      return;
    }

    set(ref(db, "shopartikel/" + id), {
      name, preis, lieferzeit, beschreibung
    });

    document.getElementById("artikel-id").value = "";
    document.getElementById("artikel-name").value = "";
    document.getElementById("artikel-preis").value = "";
    document.getElementById("artikel-lieferzeit").value = "";
    document.getElementById("artikel-beschreibung").value = "";
  };

  window.bearbeiten = (id, name, preis, lieferzeit, beschreibung) => {
    document.getElementById("artikel-id").value = id;
    document.getElementById("artikel-name").value = name;
    document.getElementById("artikel-preis").value = preis;
    document.getElementById("artikel-lieferzeit").value = lieferzeit;
    document.getElementById("artikel-beschreibung").value = beschreibung;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  renderProdukte();
</script>
</body>
</html>
