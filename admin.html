<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mousecity Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f3f3;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #232f3e;
            color: white;
            padding: 10px 20px;
        }
        
        header h1 {
            margin: 0;
            font-size: 1.2em;
        }

        main {
            padding: 20px;
        }
        
        .back-link {
            color: white;
            text-decoration: none;
            font-size: 1em;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section h2 {
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }

        .admin-section ul {
            list-style: none;
            padding: 0;
        }

        .admin-section li {
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .admin-section li button {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 10px;
        }

        .admin-section li button.delete-btn {
            color: red;
        }

        .admin-section li button.edit-btn {
            color: #3498db;
        }

        #product-form input, #product-form textarea, #product-form select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #save-product-button, #add-category-button {
            background-color: #ffd814;
            border: 1px solid #fcd200;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 15px;
        }

        #review-list li, #return-requests-list li {
            flex-direction: column;
            align-items: flex-start;
        }
        .review-text {
            font-style: italic;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .order-actions button {
            margin: 5px 5px 0 0;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>

    <header>
        <h1>Mousecity Admin-Backend</h1>
        <a href="index.html" class="back-link">← Zurück zum Shop</a>
    </header>

    <main>
        <section class="admin-section">
            <h2>Bestellungen in Bearbeitung</h2>
            <ul id="pending-orders-list"></ul>
        </section>

        <hr>

        <section class="admin-section">
            <h2>Bestellungen (Geliefert oder Abgelehnt)</h2>
            <ul id="processed-orders-list"></ul>
        </section>
        
        <hr>

        <section class="admin-section">
            <h2>Rückgabeanfragen</h2>
            <ul id="return-requests-list"></ul>
        </section>

        <hr>

        <section class="admin-section">
            <h2>Kategorien-Verwaltung</h2>
            <div id="category-form">
                <input type="text" id="category-name-input" placeholder="Neue Kategorie">
                <button id="add-category-button">Kategorie hinzufügen</button>
            </div>
            <ul id="category-list"></ul>
        </section>
        
        <hr>

        <section class="admin-section">
            <h2>Produktverwaltung</h2>
            <div id="product-form">
                <input type="hidden" id="product-id">
                <input type="text" id="product-name-input" placeholder="Produktname" required>
                <input type="number" id="product-price-input" placeholder="Preis (Mausdollar)" required>
                <input type="number" id="product-stock-input" placeholder="Bestand (Anzahl)" required>
                <input type="text" id="product-delivery-input" placeholder="Lieferzeit" required>
                <input type="text" id="product-image-input" placeholder="Bild-URL (Link zum Bild)">
                <textarea id="product-description-input" placeholder="Beschreibung (optional)"></textarea>
                <select id="product-category-select">
                    <option value="">-- Kategorie auswählen --</option>
                </select>
                <button id="save-product-button">Produkt hinzufügen</button>
            </div>
            <ul id="products-list"></ul>
        </section>

        <hr>

        <section class="admin-section">
            <h2>Bewertungen</h2>
            <ul id="review-list"></ul>
        </section>
    </main>

    <script>
        // Firebase-Konfiguration
        const firebaseConfigPunkte = {
            apiKey: "DEIN_API_KEY_MUSS_HIER_EINGEFUEGT_WERDEN",
            databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
        };
        const appPunkte = firebase.initializeApp(firebaseConfigPunkte);
        const dbPunkte = appPunkte.database();

        // Admin-Logik
        const pendingOrdersList = document.getElementById('pending-orders-list');
        const processedOrdersList = document.getElementById('processed-orders-list');
        const returnRequestsList = document.getElementById('return-requests-list');
        const productsList = document.getElementById('products-list');
        const saveProductButton = document.getElementById('save-product-button');
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name-input');
        const productPriceInput = document.getElementById('product-price-input');
        const productStockInput = document.getElementById('product-stock-input');
        const productDeliveryInput = document.getElementById('product-delivery-input');
        const productDescriptionInput = document.getElementById('product-description-input');
        const productImageInput = document.getElementById('product-image-input');
        const productCategorySelect = document.getElementById('product-category-select');

        const categoryNameInput = document.getElementById('category-name-input');
        const addCategoryButton = document.getElementById('add-category-button');
        const categoryList = document.getElementById('category-list');

        const reviewList = document.getElementById('review-list');
        let categories = {};

        const loadCategories = () => {
            const categoriesRef = dbPunkte.ref('kategorien');
            categoriesRef.on('value', (snapshot) => {
                categoryList.innerHTML = '';
                productCategorySelect.innerHTML = '<option value="">-- Kategorie auswählen --</option>';
                categories = snapshot.val() || {};
                if (categories) {
                    Object.keys(categories).forEach(key => {
                        const categoryName = categories[key];
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${categoryName}</span>
                            <button class="delete-btn" data-id="${key}">x</button>
                        `;
                        categoryList.appendChild(li);

                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = categoryName;
                        productCategorySelect.appendChild(option);
                    });
                }
            });
        };

        addCategoryButton.addEventListener('click', () => {
            const categoryName = categoryNameInput.value.trim();
            if (categoryName) {
                dbPunkte.ref('kategorien').push(categoryName);
                categoryNameInput.value = '';
            }
        });

        categoryList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const categoryId = e.target.dataset.id;
                dbPunkte.ref(`kategorien/${categoryId}`).remove();
            }
        });

        const loadOrders = () => {
            const ordersRef = dbPunkte.ref('bestellungen');
            ordersRef.on('value', (snapshot) => {
                pendingOrdersList.innerHTML = '';
                processedOrdersList.innerHTML = '';
                const orders = snapshot.val();
                if (orders) {
                    Object.keys(orders).forEach(key => {
                        const order = orders[key];
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>
                                <strong>${order.name}</strong> hat ${order.artikel} bestellt.<br>
                                <small>Kaufpreis: ${order.gezahlterPreis} Mausdollar, Datum: ${new Date(order.kaufdatum).toLocaleDateString()}</small><br>
                                <small>Status: ${order.status}</small>
                            </span>
                            <div class="order-actions"></div>
                        `;

                        if (order.status === 'wird geliefert') {
                             const confirmButton = document.createElement('button');
                             confirmButton.textContent = 'Lieferung bestätigen';
                             confirmButton.className = 'confirm-delivery-btn';
                             confirmButton.dataset.orderId = key;
                             li.querySelector('.order-actions').appendChild(confirmButton);
                             
                             const rejectButton = document.createElement('button');
                             rejectButton.textContent = 'Kauf ablehnen';
                             rejectButton.className = 'reject-purchase-btn';
                             rejectButton.dataset.orderId = key;
                             rejectButton.dataset.price = order.gezahlterPreis;
                             rejectButton.dataset.userName = order.name;
                             rejectButton.dataset.userType = order.userType;
                             li.querySelector('.order-actions').appendChild(rejectButton);

                             pendingOrdersList.appendChild(li);
                        } else {
                            processedOrdersList.appendChild(li);
                        }
                    });
                }
            });
        };
        
        pendingOrdersList.addEventListener('click', (e) => {
            if (e.target.classList.contains('confirm-delivery-btn')) {
                const orderId = e.target.dataset.orderId;
                dbPunkte.ref(`bestellungen/${orderId}/status`).set('Produkt geliefert');
            } else if (e.target.classList.contains('reject-purchase-btn')) {
                const orderId = e.target.dataset.orderId;
                const price = parseFloat(e.target.dataset.price);
                const userName = e.target.dataset.userName;
                const userType = e.target.dataset.userType;
                
                dbPunkte.ref(`${userType}/${userName}`).once('value', snapshot => {
                    const user = snapshot.val();
                    if (user) {
                        const newPoints = (user.punkte || 0) + price;
                        dbPunkte.ref(`${userType}/${userName}/punkte`).set(newPoints);
                    }
                });

                dbPunkte.ref(`bestellungen/${orderId}/status`).set('Kauf abgelehnt');
                alert(`Kauf von ${userName} abgelehnt. ${price} Mausdollar wurden erstattet.`);
            }
        });


        const loadProductsAdmin = () => {
            const productsRef = dbPunkte.ref('shopartikel');
            productsRef.on('value', (snapshot) => {
                productsList.innerHTML = '';
                const products = snapshot.val();
                if (products) {
                    Object.keys(products).forEach(key => {
                        const product = products[key];
                        const li = document.createElement('li');
                        const categoryName = categories[product.kategorie] || 'Ohne Kategorie';
                        li.innerHTML = `
                            <span>
                                <strong>${product.name}</strong> - ${product.preis} Mausdollar (Bestand: ${product.stock || 0}) <br>
                                <small>Kategorie: ${categoryName}</small>
                            </span>
                            <div>
                                <button class="edit-btn" data-id="${key}" data-name="${product.name}" data-price="${product.preis}" data-stock="${product.stock || 0}" data-delivery="${product.lieferzeit}" data-description="${product.beschreibung || ''}" data-image="${product.image || ''}" data-category="${product.kategorie || ''}">✏️</button>
                                <button class="delete-btn" data-id="${key}">x</button>
                            </div>
                        `;
                        productsList.appendChild(li);
                    });
                }
            });
        };

        saveProductButton.addEventListener('click', () => {
            const name = productNameInput.value;
            const price = parseInt(productPriceInput.value);
            const stock = parseInt(productStockInput.value);
            const delivery = productDeliveryInput.value;
            const description = productDescriptionInput.value;
            const image = productImageInput.value;
            const category = productCategorySelect.value;
            const productId = productIdInput.value;

            if (!name || isNaN(price) || isNaN(stock) || !delivery || !category) {
                alert('Name, Preis, Bestand, Lieferzeit und Kategorie sind erforderlich!');
                return;
            }

            const productData = { name, preis: price, stock: stock, lieferzeit: delivery, beschreibung: description, image: image, kategorie: category };
            const productsRef = dbPunkte.ref('shopartikel');

            if (productId) {
                productsRef.child(productId).set(productData);
                alert('Produkt aktualisiert!');
            } else {
                productsRef.push(productData);
                alert('Produkt hinzugefügt!');
            }
            
            productIdInput.value = '';
            productNameInput.value = '';
            productPriceInput.value = '';
            productStockInput.value = '';
            productDeliveryInput.value = '';
            productDescriptionInput.value = '';
            productImageInput.value = '';
            productCategorySelect.value = '';
            saveProductButton.textContent = 'Produkt hinzufügen';
        });

        productsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const productId = e.target.dataset.id;
                dbPunkte.ref(`shopartikel/${productId}`).remove();
            } else if (e.target.classList.contains('edit-btn')) {
                const productId = e.target.dataset.id;
                productIdInput.value = productId;
                productNameInput.value = e.target.dataset.name;
                productPriceInput.value = e.target.dataset.price;
                productStockInput.value = e.target.dataset.stock;
                productDeliveryInput.value = e.target.dataset.delivery;
                productDescriptionInput.value = e.target.dataset.description;
                productImageInput.value = e.target.dataset.image;
                productCategorySelect.value = e.target.dataset.category;
                saveProductButton.textContent = 'Produkt aktualisieren';
            }
        });
        
        const loadReviews = () => {
            const reviewsRef = dbPunkte.ref('bewertungen');
            reviewsRef.on('value', (snapshot) => {
                reviewList.innerHTML = '';
                const reviews = snapshot.val();
                if (reviews) {
                    Object.keys(reviews).forEach(key => {
                        const review = reviews[key];
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>
                                <strong>Produkt:</strong> ${review.productName} <br>
                                <strong>Von:</strong> ${review.userName} <br>
                                <strong>Bewertung:</strong> ${'⭐'.repeat(review.rating)} <br>
                                <span class="review-text">${review.comment}</span>
                            </span>
                            <button class="delete-btn" data-id="${key}">x</button>
                        `;
                        reviewList.appendChild(li);
                    });
                }
            });
        };

        reviewList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const reviewId = e.target.dataset.id;
                dbPunkte.ref(`bewertungen/${reviewId}`).remove();
            }
        });

        const loadReturnRequests = () => {
            const requestsRef = dbPunkte.ref('ruecksendeanfragen');
            requestsRef.on('value', (snapshot) => {
                returnRequestsList.innerHTML = '';
                const requests = snapshot.val();
                if (requests) {
                    Object.keys(requests).forEach(key => {
                        const request = requests[key];
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>
                                <strong>Anfrage von:</strong> ${request.userName} <br>
                                <strong>Produkt:</strong> ${request.productName} <br>
                                <strong>Grund:</strong> ${request.reason} <br>
                                <small>Bestell-ID: ${request.orderId}</small>
                            </span>
                            <div>
                                <button class="accept-btn" data-id="${key}" data-order-id="${request.orderId}" data-price="${request.purchasePrice}" data-user-name="${request.userName}" data-user-type="${request.userType}">Annehmen</button>
                                <button class="delete-btn" data-id="${key}" data-order-id="${request.orderId}">Ablehnen</button>
                            </div>
                        `;
                        returnRequestsList.appendChild(li);
                    });
                } else {
                    returnRequestsList.innerHTML = '<li>Keine offenen Rückgabeanfragen.</li>';
                }
            });
        };

        returnRequestsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const requestId = e.target.dataset.id;
                const orderId = e.target.dataset.orderId;
                dbPunkte.ref(`bestellungen/${orderId}/returnStatus`).set('abgelehnt');
                dbPunkte.ref(`ruecksendeanfragen/${requestId}`).remove();
            } else if (e.target.classList.contains('accept-btn')) {
                const requestId = e.target.dataset.id;
                const orderId = e.target.dataset.orderId;
                const purchasePrice = parseFloat(e.target.dataset.price);
                const userName = e.target.dataset.userName;
                const userType = e.target.dataset.userType;

                const userRef = dbPunkte.ref(`${userType}/${userName}`);
                userRef.once('value', (snapshot) => {
                    const user = snapshot.val();
                    if (user) {
                        const newPoints = (user.punkte || 0) + purchasePrice;
                        userRef.child('punkte').set(newPoints);
                        
                        dbPunkte.ref(`bestellungen/${orderId}/returnStatus`).set('angenommen');
                        dbPunkte.ref(`ruecksendeanfragen/${requestId}`).remove();
                        alert(`Rücksendung angenommen. ${purchasePrice} Mausdollar wurden ${userName} gutgeschrieben.`);
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
            loadCategories();
            loadProductsAdmin();
            loadReviews();
            loadReturnRequests();
        });
    </script>
</body>
</html>
